name: Build and Publish to Chrome Web Store

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create extension zip
        run: |
          zip -r extension.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "*.md" \
            -x "*.zip"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-v${{ steps.version.outputs.version }}
          path: |
            manifest.json
            background.js
            popup.html
            popup.js
            offscreen.html
            offscreen.js
            transformers.min.js
            icons/

      - name: Publish to Chrome Web Store
        run: |
          # Get access token from refresh token
          ACCESS_TOKEN=$(curl -s -X POST "https://oauth2.googleapis.com/token" \
            -d "client_id=${{ secrets.CHROME_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.CHROME_CLIENT_SECRET }}" \
            -d "refresh_token=${{ secrets.CHROME_REFRESH_TOKEN }}" \
            -d "grant_type=refresh_token" | jq -r '.access_token')

          # Upload the extension
          curl -s -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -T extension.zip \
            "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}"

          # Publish it
          curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "x-goog-api-version: 2" \
            -H "Content-Length: 0" \
            "https://www.googleapis.com/chromewebstore/v1.1/items/${{ secrets.CHROME_EXTENSION_ID }}/publish"
